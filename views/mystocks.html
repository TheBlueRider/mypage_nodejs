{% extends 'layout.html' %}
{% block title %}
	<title>股票</title>
{% endblock %}
{% block style %}
  <style>
  .navbar-nav>li>a, .navbar-brand {
    color: white !important;
    border-radius: 0.3em;
  }

  .navbar-nav>li>a:hover, .navbar-brand:hover {
    color: rgba(175, 182, 187, 1) !important;
  }

  .navbar-nav > .active > a {
      background-color: white !important;
      color: rgba(33, 47, 63, 1) !important;
  }
  </style>
{% endblock %}

{% block javascript %}
  <script src="https://cdn.socket.io/socket.io-1.3.5.js"></script>
  <script>
      var price = 'none';
      //var socket = io.connect('https://bluerider-haochenyao.rhcloud.com:8443');
      var socket = io.connect('http://localhost:8082');
      socket.on('newinfos', function(message) {
				var value_total = 0;
				var different_total = 0;
        var index = 0;
        $('#stock_table tr').each(function() {
          var stock_id = $(this).find(".stockid").html();
          if (stock_id != undefined && message[index] != undefined) {
            $(this).find(".stockname").html(message[index][0]);
            $(this).find(".priceyesclose").html(message[index][2]);
            $(this).find(".pricetodopen").html(message[index][1]);
            $(this).find(".pricenow").html(message[index][3] + "(" +
                ((parseFloat(message[index][3])-parseFloat(message[index][2]))/parseFloat(message[index][2])*100).toFixed(2)
                + "%)");
            if (parseFloat(message[index][3]) < parseFloat(message[index][2]))
              $(this).find(".pricenow").css("color", "green");
            else if (parseFloat(message[index][3]) > parseFloat(message[index][2]))
              $(this).find(".pricenow").css("color", "red");
            else
              $(this).find(".pricenow").css("color", "black");
						var value = parseFloat(message[index][3]) * parseFloat($(this).find(".numberbuy").html()) / 10000;
						var difference = (parseFloat(message[index][3])
															- parseFloat($(this).find(".pricebuy").html()))
															* parseFloat($(this).find(".numberbuy").html())/10000;
						value_total += value;
						different_total += difference;
						$(this).find(".value").html(value.toFixed(1)+'('+difference.toFixed(1)+')');
            if (difference < 0)
              $(this).find(".value").css("color", "green");
						else if (difference > 0)
							$(this).find(".value").css("color", "red");
						index++;
          }
        });

				$("#value_total").html(value_total.toFixed(1)+'('+different_total.toFixed(1)+')');
				if (different_total < 0)
					$("#value_total").css("color", "green");
				else if (different_total > 0)
					$("#value_total").css("color", "red");
      });

      socket.on('positionclose', function(message) {
        var index = 0;
        $('#stock_table tr').each(function() {
          var stock_id = $(this).find(".stockid").html();
          if (stock_id != undefined && message[index] != undefined) {
            $(this).find(".positionclose").html(message[index]);
            index++;
          }
        });
      });

			function removestock(stock_id) {
				var confirm = confirm("确认删除");
				loadingbegin();
				if (confirm) {
					$ajax.get('../remove/'+stock_id, function(data){
						loadingfinish();
						document.location = "../mystocks";
					})
				}
			}
  </script>
{% endblock %}

{% block content %}
  <nav class="navbar navbar-inverse">
    <div class="container">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#mongodb-navbar-collapse-1">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="/">TheBlueRider</a>
      </div>

      <div class="collapse navbar-collapse" id="mongodb-navbar-collapse-1">
        <ul class="nav navbar-nav navbar-right">
          <li class="active">
            <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">股票<span class="caret"></span></a>
            <ul class="dropdown-menu" role="stock">
              <li><a href="/newstock">添加</a></li>
              <li><a href="/mystocks">查看</a></li>
              <li><a href="/histories">交易历史</a></li>
            </ul>
          </li>
          <li><a href="#" target="_blank">Contact</a></li>
        </ul>
      </div><!-- END .navbar-collapse -->
    </div><!-- END .container-fluid -->
  </nav>

<div>
  <div class="container tab-responsive>">
    <table class="table" id="stock_table">
      <caption>股票</caption>
      <thead>
      <tr>
        <th>代码</th>
        <th>股票名</th>
        <th>昨收(元)</th>
        <th>今开(元)</th>
        <th>现价(元)</th>
        <th>购买价(元)</th>
        <th>购买数(股)</th>
        <th>价值(万)</th>
        <th>止损点(元)</th>
        <th>操作</th>
        <th>k线图</th>
      </tr>
      </thead>
      <tbody>
      {% for stock in mystocks %}
      <tr>
        <td class="stockid" data-title="代码">{{ stock['stock_id'] }}</td>
        <td class="stockname" data-title="股票名"></td>
        <td class="priceyesclose" data-title="昨收"></td>
        <td class="pricetodopen" data-title="今开"></td>
        <td class="pricenow" data-title="现价"></td>
        <td class="pricebuy" data-title="购买价">{% if stock['price_buy'] %}{{ stock['price_buy']|floatpoint(2) }}{% else %}0{% endif %}</td>
        <td class="numberbuy" data-title="购买数">{% if stock['number_buy'] %}{{ stock['number_buy'] }}{% else %}0{% endif %}</td>
        <td class="value" data-title="价值"></td>
        <td class="positionclose" data-title="止损点"></td>
				<td class="do" data-title="操作">
					<a class="btn btn-default" href="../trade/{{ stock['stock_id'] }}">购/售</a>
					<button class="btn btn-default" onclick="removestock({{ stock['stock_id'] }});">删除</button>
				</td>
        <td data-title="k线图"><a class="btn btn-default" href="../candlestick/{{ stock['stock_id'] }}">查看</a></td>
      </tr>
      {% endfor %}
			<tr>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td id="value_total"></td>
        <td></td>
        <td></td>
				<td></td>
        <td></td>
      </tr>
    </tbody>
    </table>
  </div>
</div>
{% endblock %}}
